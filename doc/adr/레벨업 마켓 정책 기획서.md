# 🍎 레벨업 마켓 기획 문서

본 문서는 식품(신선/가공식품) 기반 이커머스 시스템 구축을 위한 정책 및 식별자 규칙을 정리한 기획 문서입니다.  

---

## 1) 역할 정의 (RBAC)
- **ROLE_USER**: 일반 소비자, 주문/리뷰/환불 요청 가능  
- **ROLE_ADMIN**: 전체 관리 (상품, 주문, 재고, CS, 배너, 공지)  
- **ROLE_MANAGER**: 주문·배송·CS 전담 운영자  
- **ROLE_MARKETER**: 배너, 이벤트, 프로모션 전담  
- **ROLE_AUDITOR**: 읽기 전용(감사/로그 확인)  

---

## 2) 로그인/보안 정책
- **인증**: JWT 기반 (Access: 30분, Refresh: 14일, 슬라이딩 갱신)  
- **비밀번호 정책**: 10자 이상, 대소문자/숫자/특수문자 포함, 90일 만료  
- **권한 검사**: Spring Security `@PreAuthorize` + URL 패턴 기반 방어   
- **파일 업로드**: 확장자/콘텐츠타입 화이트리스트, 바이러스 스캔(선택), S3 사전서명 URL  

---

## 3) 메뉴 정책 (권한별)

### 사용자 (ROLE_USER)
- 홈(메인) → 오늘의 특가, 신상품, 카테고리  
- 상품 카탈로그 → 신선식품/냉동식품/가공식품 카테고리 구분  
- 장바구니 / 주문 → 냉동·냉장·상온 상품 묶음 처리  
- 마이페이지 → 주문/배송 추적, 개인정보 수정, 쿠폰/포인트  
- 리뷰/평점 → 품질·신선도·포장 상태 기준 리뷰 작성  
- 고객센터 → 환불/품질 불만 접수  

메뉴 리스트
-  홈(메인)
- 카탈로그
  - 카테고리/브랜드/검색 결과
  - 상품 상세
- 장바구니
- 주문
  - 주문하기/주문내역/주문상세/배송추적
- 마이페이지
  - 프로필/비밀번호 변경
  - 주소록
  - 쿠폰/포인트
  - 찜/최근 본 상품(선택)
  - 나의 리뷰
  - 1:1 문의 내역
- 공지사항 / 고객센터

### 관리자 (ROLE_ADMIN)
- 상품 관리 → 유통기한/보관조건 필수 입력  
- 재고 관리 → 냉장/냉동/상온 카테고리별 재고 관리  
- 주문/배송 관리 → 새벽배송/당일배송/택배 구분  
- CS 관리 → 품질 불량 접수 시 즉시 환불 처리 버튼 제공  
- 마케팅 → 프로모션, 유통기한 임박상품 할인 적용  
- 시스템 → 배송사 API 연동 상태 모니터링, 공지 관리  

메뉴 리스트
- 대시보드(매출/주문/재고/이슈 요약)
- 상품 관리
  - 상품/옵션 등록·수정
  - 이미지/카테고리/브랜드
  - 리뷰 관리(블라인드/신고 처리)
- 재고/물류
  - SKU 재고/안전재고/입출고(선택)
  - 배송사 연동 상태/운송장 재조회
- 주문/결제
  - 주문 목록/상세/상태 변경
  - 환불/취소/부분환불
  - 결제 로그/콜백 이력
- 고객센터
  - 문의/답변 템플릿(매크로)
  - 공지/FAQ
  - 블라인드/신고
- 마케팅
  - 배너/카드배너(스코어/우선순위)
  - 쿠폰/프로모션/이벤트
  - 추천 슬롯(실험/AB Test)
- 회원/권한
  - 회원 조회/제재(잠금/해제)
  - 역할/권한 부여(2인 승인 옵션)
- 시스템
  - 설정(결제/배송/메일/SMS 키)
  - 통합 로그/감사 로그
  - 웹훅/외부 연동 상태
  - 기능 플래그(Feature Flags)
  - 작업 내역(배치/캐시/인덱스)

> **ROLE_MANAGER**: “상품/주문/고객센터”만 노출(설정/권한/시스템 비노출)  
> **ROLE_MARKETER**: “마케팅/콘텐츠(공지, 배너)/대시보드(읽기)”  
> **ROLE_AUDITOR**: 전 메뉴 읽기 전용, 쓰기 버튼 비노출

---

## 4) 접근 권한 매트릭스

| 기능 | USER | ~~MANAGER~~ | ~~MARKETER~~ | ADMIN | ~~AUDITOR~~ |
|------|------|---------|----------|-------|---------|
| 상품 조회 | R | R | R | R/W | R |
| 상품 등록/수정 | - | - | - | W | - |
| 유통기한/보관조건 관리 | - | - | - | W | R |
| 리뷰 작성 | W(구매자) | M(블라인드) | - | M | R |
| 장바구니/주문 | W | R/W | - | R/W | R |
| 배송 추적 | 자기 주문 | R/W | - | R/W | R |
| 환불/취소 | 자기 주문 | R/W | - | R/W | R |
| CS 접수/답변 | 자기 문의 | W | - | R/W | R |
| 배너/프로모션 | R | - | W | W | R ||
| 결제 콜백/조회 | - | R | - | R/W | R |
| 문의 작성/열람 | 자기 것 | R/W(답변) | - | R/W | R |
| 공지/배너/쿠폰 | R | - | R/W | R/W | R |
| 회원/권한 | 자기 계정 | - | - | R/W | R |
| 시스템 설정/로그 | - | - | - | R/W | R |

> R: 읽기, W: 쓰기/수정/변경, M: 모더레이션(블라인드/신고처리)

---

## 5) 업무/도메인 정책

### 상태 흐름
- **장바구니 → 주문생성(PENDING) → 결제시도(PAYING) → 결제완료(PAID) → 배송준비(READY) → 배송중(SHIPPED) → 배송완료(DELIVERED) → 구매확정(CONFIRMED)**
- 취소 가능:
  - **PENDING/PAYING/PAID/READY** 단계에서만(정책상 마감시간 전)
- 환불:
  - **PAID/READY/SHIPPED**(부분 환불 가능, 배송비 정책 반영)
  - **DELIVERED/CONFIRMED**은 반품 프로세스 별도(기간/상태/검수 결과 반영)

### 주문/배송
- **배송 유형**: 새벽배송, 당일배송, 일반 택배  
- **배송 분리**: 냉동/냉장/상온 상품은 각각 별도 배송 단위 생성  
- **운송장 연계**: 배송사 API 자동 조회  
- **상태 흐름**: 주문접수 → 결제완료 → 상품 준비 → 배송중 → 배송완료  

### 재고/유통기한
- **재고 단위**: SKU + 유통기한 Batch 단위  
- **소진 정책**: 임박 상품부터 자동 차감(FIFO)  
- **임박 처리**: 남은 유통기한 3일 이내 → 자동 할인 태깅  

### 환불/반품
- **단순 변심**: 개봉 전, 냉장·냉동 식품은 환불 불가  
- **품질 문제**: 사진 증빙 시 100% 환불 (재고 복구 제외)  
- **배송 문제**: 지연/파손 시 전액 환불 및 재배송 선택 가능  

### 리뷰
- **작성 조건**: 구매자 한정, 배송완료 후 작성 가능  
- **항목**: 신선도, 맛, 포장 상태, 가성비(별점 1~5)  
- **사진 첨부**: 신선도 증빙용 사진 권장, 개수/용량 제한(5장/20MB)  
- **평점**: 1~5, 평균은 소수점 1자리 반올림  
- **모더레이션**: ~~금칙어/스팸 필터~~, 신고 3건↑ 자동 숨김(관리자 검토)  

### 쿠폰/프로모션
- **신규회원 쿠폰**: 첫 구매 무료배송/할인  
- **임박상품 쿠폰**: 유통기한 3일 이내 자동 발급 가능  
- **중복 제한**: 장바구니 쿠폰 + 상품쿠폰 중복 불가  

---

## 6) 비기능적 요구사항
- **성능**: 상품 조회 200ms 이내, 재고 동기화 지연 1초 이내  
- **안정성**: 주문/결제 100TPS 이상  
- **보안**: TLS 1.2 이상, JWT 인증, 개인정보 암호화  
- **확장성**: 다중 창고/물류센터 관리, 지역별 배송 확장 가능  
- **읽기 최적화**: 베스트/인기/배너는 Redis 캐시(5~10분)  
- **리스트 페이지네이션**: offset → (트래픽 증가 시) keyset 탑재  
- **검색 전략**:  
  - 1단계: DB LIKE + 인덱스 최적화(brand, price, created_at, sales_count)  
  - 2단계: ES 전환(동기화: Outbox/Event-Driven)

---

## 7) 법적 준수
- **식품위생법**: 원산지, 알레르기 유발 물질, 유통기한 필수 표기  
- **환불 규정**: 변심 환불 제한 정책 고지 필요  
- **개인정보 보호**: 배송지/연락처 암호화 저장  
  - **최소 수집** 원칙, 민감정보 저장 금지  
  - **가명화/마스킹**: 관리화면 노출 시 이메일/전화 일부 마스킹  
  - **탈퇴**: 법정 보존 제외 데이터 영구 삭제(비가역)  
- **감사 로그**: 환불/재고 변경 내역 1년 보관  

---

## 8) 운영 가드레일
- **재고 부족 알림**: 임계 재고 도달 시 관리자 알림  
- **콜드체인 모니터링**: 배송 중 온도 이상 발생 시 알림  

---

## 9) 식별자 정책

### 공통 원칙
- 내부 PK는 **Auto Increment 정수 ID** 사용  
- 외부 노출용은 **Prefix + 날짜 + Seq** 형태  
- 불변성 보장, Soft Delete 시에도 ID 유지  

### 도메인별 규칙
- **회원(User)**  
  - PK: `user_id` (auto increment)  
  - 외부 ID: `USR-{yyyyMMdd}-{seq}`  
  - 로그인 ID/이메일/휴대폰은 Unique Index  

- **상품(Product)**  
  - PK: `product_id` (auto increment)  
  - 외부 ID: `PRD-{categoryCode}-{seq}`  
  - 옵션 SKU: `SKU-{productId}-{optionCode}`  

- **주문(Order)**  
  - PK: `order_id` (auto increment)  
  - 외부 ID: `ORD-{yyyyMMddHHmmss}-{seq}`  
  - 주문아이템별 별도 `order_item_id`  

- **결제(Payment)**  
  - PK: `payment_id` (auto increment)  
  - 외부 ID: `PAY-{orderId}-{seq}`  
  - PG 거래번호(`pg_tx_id`) 매핑 필요  

- **배송(Shipment)**  
  - PK: `shipment_id` (auto increment)  
  - 외부 ID: 배송사 `tracking_number`  

- **쿠폰(Coupon)**  
  - PK: `coupon_id` (auto increment)  
  - 외부 ID: `CPN-{yyyyMMdd}-{seq}`  
  - 발급 단위 issue_id 별도 관리  

- **리뷰(Review)**  
  - PK: `review_id` (auto increment)  
  - 외부 ID: `REV-{orderItemId}`  

- **관리자(Admin)**  
  - PK: `admin_id` (auto increment)  
  - 외부 ID: `ADM-{yyyyMMdd}-{seq}`  
  - 활동은 `audit_log_id` 로 별도 추적  

---

## 10) 기본 API 레이트 리밋(권장 초기값)

| 구분 | 익명 | USER | ADMIN |
|---|---:|---:|---:|
| 로그인 시도 | 5/분 | 5/분 | 5/분 |
| 상품 검색 | 60/분 | 120/분 | 120/분 |
| 주문 생성 | - | 10/분 | 60/분 |
| 관리자 쓰기(상품/배너) | - | - | 60/분 |
| 배송 재조회 | - | - | 30/분 |

> 429 응답 + Retry-After 헤더. 관리 콘솔에서 조정 가능하도록.

---

## 11) 기본 설정 값(디폴트)
- 리뷰 작성 가능 기간: **구매확정 후 30일**
- 재고 임시홀드 TTL: **10분**
- 배너 캐시 TTL: **5분**
- 포인트 적립률: **1%**
- 무료배송 기준: **주문합계 50,000원 이상**(예시)
- 교환/반품 접수 기한: **수령 후 7일**(전자상거래법 고려)